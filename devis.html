<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Devis complet</title>
<style>
  :root {
    --primary-color: #15395d;
    --secondary-color: #2874a6;
    --bg-color: #fff;
    --text-color: #222;
    --text-light: #555;
    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    --font-size-base: 11px;
    --font-weight-normal: 400;
    --font-weight-bold: 700;
    --radius: 4px;
  }
  body {
    font-family: var(--font-family);
    background-color: #2d2d2e;
    color: #d0d0d0;
    margin: 0;
    display: flex;
    min-height: 100vh;
    user-select: none;
  }
  /* Mode sombre avancé spécifique au panel #configPanel */

#configPanel {
  background-color: #1e1e1e !important;
  color: #d0d0d0 !important;
  border: 1px solid #444 !important;
  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.7) !important;
}

#configPanel h2 {
  color: #5dade2 !important;  /* un bleu clair pour les titres */
  border-bottom-color: #5dade2 !important;
}

#configPanel label {
  color: #aab7c4 !important;
}

#configPanel input[type="text"],
#configPanel input[type="email"],
#configPanel input[type="date"],
#configPanel input[type="number"],
#configPanel textarea,
#configPanel select {
  background-color: #333 !important;
  color: #eee !important;
  border: 1.5px solid #555 !important;
  transition: border-color 0.3s ease, background-color 0.3s ease;
}

#configPanel input[type="text"]:focus,
#configPanel input[type="email"]:focus,
#configPanel input[type="date"]:focus,
#configPanel input[type="number"]:focus,
#configPanel textarea:focus,
#configPanel select:focus {
  background-color: #444 !important;
  border-color: #5dade2 !important;
  outline: none;
  color: #fff !important;
}

#configPanel button {
  background-color: #2874a6 !important;
  color: white !important;
  border: none !important;
  box-shadow: 0 2px 6px rgba(40, 116, 166, 0.7) !important;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

#configPanel button:hover,
#configPanel button:focus {
  background-color: #1b4a7a !important;
  box-shadow: 0 4px 12px rgba(27, 74, 122, 0.9) !important;
  outline: none;
}

/* Scrollbar du panel */
#configPanel::-webkit-scrollbar {
  width: 8px;
}

#configPanel::-webkit-scrollbar-track {
  background: #222;
}

#configPanel::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 10px;
  border: 2px solid #222;
}

/* Panel édition article (cadre bleu clair) en mode sombre */
#articleEditGlobal {
  background-color: #2a2a2a !important; /* gris foncé */
  color: #d0d0d0 !important;
  border-radius: 8px;
  padding: 20px;
  box-sizing: border-box;
  box-shadow: 0 4px 16px rgba(0,0,0,0.7);
  max-width: 400px;
  margin-bottom: 20px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Titres et labels */
#articleEditGlobal h3 {
  color: #5dade2 !important; /* bleu clair */
  margin-top: 0;
  font-weight: 700;
  user-select: none;
}

#articleEditGlobal label {
  color: #aab7c4 !important;
  font-weight: 600;
  display: block;
  margin-top: 12px;
}

/* Inputs et textarea */
#articleEditGlobal textarea,
#articleEditGlobal input[type="number"] {
  background-color: #1e1e1e !important;
  color: #ddd !important;
  border: 1.5px solid #555 !important;
  border-radius: 6px;
  padding: 10px;
  font-size: 14px;
  font-family: inherit;
  resize: vertical;
  width: 100%;
  box-sizing: border-box;
  transition: border-color 0.3s ease, background-color 0.3s ease;
}

#articleEditGlobal textarea:focus,
#articleEditGlobal input[type="number"]:focus {
  background-color: #333 !important;
  border-color: #5dade2 !important;
  outline: none;
  color: #fff !important;
}

/* Bouton Enregistrer */
#saveGlobalEditBtn {
  background-color: #2874a6 !important;
  color: white !important;
  border: none !important;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 15px;
  transition: background-color 0.3s ease;
}

#saveGlobalEditBtn:hover,
#saveGlobalEditBtn:focus {
  background-color: #1b4a7a !important;
  outline: none;
}

/* Liste articles container */
#articlesList {
  background-color: #1e1e1e !important;
  border-radius: 8px;
  padding: 10px;
  max-width: 400px;
  box-sizing: border-box;
  box-shadow: 0 4px 12px rgba(0,0,0,0.7);
  overflow-y: auto;
  max-height: 320px;
}
.articleLine:last-child {
  margin-bottom: 0;
}
/* Ligne article */
.articleLine {
  background-color: #2a2a2a !important;
  color: #d0d0d0 !important;
  border-radius: 6px;
  padding: 10px 14px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  cursor: default;
  user-select: none;
  transition: background-color 0.3s ease;
}

.articleLine:hover {
  background-color: #3a3a3a !important;
}

/* Ref label */
.refLabel {
  flex-grow: 1;
  font-weight: 700;
  color: #5dade2 !important; /* bleu clair */
  user-select: text;
}

/* Boutons + et × */
.articleLine > button {
  width: 40px;
  height: 36px;
  font-weight: 700;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  user-select: none;
  transition: background-color 0.3s ease;
  font-size: 0.01rem; /* texte plus grand */
}
.articleLine > button:hover,
.articleLine > button:focus {
  background: #0f2a43;
  outline: none;
}


/* Badge info (i) */
.infoBadge {
  background-color: #2874a6 !important;
  color: white !important;
  font-size: 0.75rem !important;
  font-weight: 700 !important;
  padding: 2px 6px !important;
  border-radius: 12px !important;
  cursor: default !important;
  user-select: none !important;
  white-space: nowrap !important;
  align-self: center !important;
  margin-left: 6px;
}
#articlesList::-webkit-scrollbar {
  width: 8px;
}

#articlesList::-webkit-scrollbar-track {
  background: #121212; /* fond de la track bien sombre */
  border-radius: 8px;
}

#articlesList::-webkit-scrollbar-thumb {
  background-color: #555; /* pouce gris foncé */
  border-radius: 8px;
  border: 2px solid #121212; /* bordure qui épouse la track */
}



  
  
#logoContainer {
/* margin-right: -50px; */
  /* width: 180px;    largeur fixe, modifie à ta convenance */
  /* height: 180px;   hauteur fixe */
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

#logoImage {
  width: 25vh;
  height: 14vh;
  object-fit: contain;
  user-select: none;
  display: block;
}


  #container {
    display: flex;
    width: 100%;
    max-width: 1150px;
    margin: 20px auto;
    gap: 15px;
    padding: 0 10px;
    box-sizing: border-box;
  }
  #configPanel {
    flex: 0 0 350px;
    background: var(--bg-color);
    border-radius: var(--radius);
    padding: 15px 18px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    overflow-y: auto;
    max-height: 90vh;
    border: 1px solid #cfdde9;
    font-size: 0.85rem;
    user-select: text;
  }
  #configPanel h2 {
    color: var(--secondary-color);
    margin-top: 0;
    margin-bottom: 12px;
    font-weight: 700;
    font-size: 1.1rem;
    border-bottom: 2.5px solid var(--secondary-color);
    padding-bottom: 6px;
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px;
    transition: color 0.3s ease;
  }
  #configPanel section.collapsed h2 {
    color: var(--text-light);
  }
  #configPanel section h2::after {
    content: "▼";
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    transition: transform 0.3s ease, content 0.3s ease;
    color: var(--secondary-color);
  }
  #configPanel section.collapsed h2::after {
    transform: translateY(-50%) rotate(-90deg);
    content: "▶";
    color: var(--text-light);
  }
  #configPanel section {
    margin-bottom: 20px;
    transition: margin-bottom 0.3s ease;
  }
  #configPanel section.collapsed {
    margin-bottom: 0 !important;
  }
  #configPanel section.collapsed > *:not(h2) {
    display: none !important;
    pointer-events: none;
    margin: 0 !important;
    padding: 0 !important;
    opacity: 0 !important;
    max-height: 0 !important;
    overflow: hidden !important;
  }
  #configPanel label {
    display: block;
    margin-top: 8px;
    font-weight: var(--font-weight-bold);
    color: var(--text-light);
    cursor: pointer;
  }
  #configPanel input[type="text"],
  #configPanel input[type="email"],
  #configPanel input[type="date"],
  #configPanel input[type="number"],
  #configPanel textarea,
  #configPanel select {
    width: 100%;
    padding: 5px 9px;
    margin-top: 3px;
    font-size: 0.9rem;
    font-weight: var(--font-weight-normal);
    border: 1.4px solid #cfdde9;
    border-radius: var(--radius);
    box-sizing: border-box;
    resize: vertical;
    background: #fafafa;
    color: var(--text-color);
    transition: border-color 0.25s ease, background-color 0.25s ease;
  }
  #configPanel input[type="text"]:focus,
  #configPanel input[type="email"]:focus,
  #configPanel input[type="date"]:focus,
  #configPanel input[type="number"]:focus,
  #configPanel textarea:focus,
  #configPanel select:focus {
    border-color: var(--secondary-color);
    background: #fff;
    outline: none;
  }
  #configPanel textarea {
    min-height: 60px;
    line-height: 1.3;
    font-family: var(--font-family);
  }
  #configPanel button {
    margin-top: 0px;
    padding: 7px 14px;
    background: var(--secondary-color);
    color: white;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: var(--font-weight-bold);
    font-size: 0.9rem;
    user-select: none;
    box-shadow: 0 2px 5px rgba(40, 116, 166, 0.4);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  #configPanel button:hover,
  #configPanel button:focus {
    background: #1b3b5a;
  }

#devisContainer {
  flex-grow: 1;
  background: var(--bg-color);
  border-radius: var(--radius);
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  padding: 20px;
  box-sizing: border-box;
  color: var(--text-color);
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  display: flex;
  flex-direction: column;
  user-select: text;
  min-width: 800px;
  min-height: 600px;
  overflow: auto; /* Ajoute les barres de défilement si nécessaire */
  overflow-x: auto; /* Active la barre de défilement horizontale */
}
  /* En-tête style demandé */
#devisHeader {
  display: flex;
  justify-content: space-evenly; /* Toujours aligné à gauche */
  align-items: flex-start;
  gap: 71.1px;
  background: #fff;
  padding: 15px 20px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  font-size: 12px;
  color: #555;
  line-height: 1.3;
  transition: all 0.3s ease;
  align-items: center;
}

/* Logo visible */
#devisHeader.withLogo #logoContainer {
  display: block;
  flex-shrink: 0;
  max-width: 230px;
}
#devisHeader.withLogo #logoImage {
  max-height: 200px;
  max-width: 100%;
  object-fit: contain;
}

/* Logo caché */
#devisHeader.noLogo #logoContainer {
  display: none;
}

/* Gestion largeur blocs quand pas de logo */
#devisHeader.noLogo #headerLeft {
  flex-grow: 1;
  max-width: none;
  text-align: left;
}

#devisHeader.noLogo #headerRight {
  max-width: none;     /* augmente la largeur max (avant c'était 300px) */
  text-align: right;     /* texte aligné à gauche comme sur ta première image */
  margin-left: auto;    /* pousse le bloc à droite */
  white-space: normal;
  overflow-wrap: break-word;
  word-break: break-word;
}

#articlesList {
  max-height: 150px;   /* hauteur max avant scroll */
  overflow-y: auto;    /* scroll vertical automatique */
  border: 1px solid #ccc; /* optionnel, pour mieux voir la zone */
  padding: 5px;          /* optionnel, espace interne */
  background: #fafafa;   /* optionnel, fond clair */
  border-radius: 6px;    /* optionnel, coins arrondis */
}
  #headerLeft {
    max-width: 65%;
  }
  #headerLeft h2 {
    color: var(--primary-color);
    font-weight: var(--font-weight-bold);
    margin: 0 0 10px 0;
    font-size: 18px;
  }
  #headerLeft strong {
    font-weight: var(--font-weight-bold);
    color: var(--text-color);
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
  }
  #headerLeft div {
    margin-bottom: 3px;
    font-size: 13px;
    color: var(--text-light);
  }
  #headerRight {
    max-width: 30%;
    text-align: right;
    font-weight: var(--font-weight-bold);
    color: var(--text-color);
    white-space: nowrap;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }
  #dateDisplay {
    white-space: nowrap;
    margin-bottom: 10px;
  }

  /* Nouveau : infos client sous la date */
  #devisHeader #clientInfo {
    max-width: 100%;
    margin-top: 0;
    font-size: 12px;
    color: var(--text-light);
    line-height: 1.3;
    text-align: right;
    user-select: text;
  }
  #devisHeader #clientInfo strong {
    color: var(--text-color);
    font-weight: 700;
    display: block;
    margin-bottom: 5px;
  }
  #devisHeader #clientInfo p {
    margin: 0 0 4px 0;
  }
  #devisHeader #clientInfo .clientLabel {
    font-weight: 600;
    color: var(--primary-color);
  }

  @media (max-width: 600px) {
   #container {
    flex-direction: row;
  }
  #devisContainer {
    width: auto;
    min-width: 800px;  /* Conserve la largeur minimale même en petite taille */
  }
}

#devisTablesWrapper {
  border: 2px solid var(--primary-color);
  border-radius: 6px;
  overflow-x: auto; /* Permet la barre de défilement horizontale */
  background: var(--bg-color);
  max-height: 65vh;
  display: flex;
  flex-direction: column;
  overflow-x: auto;
}

#devisBody {
  padding: 0;
  margin: 0;
  /* overflow-x: auto; Permet d'activer la barre de défilement horizontale */
  background: white;
  flex-grow: 1;
  /* overflow-y: visible; Active la barre de défilement verticale si nécessaire */
}

  #devisBody table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    background: white;
    table-layout: fixed;
  }
  #devisBody table thead th {
    background-color: var(--primary-color);
    color: white;
    font-weight: 700;
    text-align: left;
    white-space: nowrap;
    padding: 6px 10px;
    border-bottom: none;
  }

  #devisBody table tbody tr {
    border-bottom: 1px solid var(--primary-color);
  }
  #devisBody table tbody tr:last-child {
    border-bottom: none;
  }
  #devisBody table tbody td {
    border-bottom: none;
    padding: 6px 10px;
    vertical-align: middle;
    word-break: break-word;
  }

  #devisBody table th:first-child,
  #devisBody table tbody td:first-child {
    width: 55%;
    white-space: normal;
  }
  #devisBody table th:nth-child(2),
  #devisBody table tbody td:nth-child(2) {
    width: 14%;
  }
  #devisBody table th:nth-child(3),
  #devisBody table tbody td:nth-child(3) {
    width: 7%;
    text-align: right;
  }
  #devisBody table th:nth-child(4),
  #devisBody table tbody td:nth-child(4) {
    width: 6%;
    text-align: right;
  }
  #devisBody table th:nth-child(5),
  #devisBody table tbody td:nth-child(5) {
    width: 7%;
    text-align: center;
  }

  #devisBody table tbody td:nth-child(2) {
    text-align: right;
    padding-bottom: 0;
  }
  #devisBody table tbody td:nth-child(2) input[type="number"] {
    border: none;
    border-bottom: 1.5px solid var(--primary-color);
    border-radius: 0;
    padding: 2px 6px;
    width: 40px;
    text-align: center;
    box-sizing: border-box;
    background: transparent;
    font-size: 12px;
    color: var(--text-color);
    outline-offset: 2px;
  }
  #devisBody table tbody td:nth-child(2) input[type="number"]:focus {
    outline: none;
    border-bottom-color: var(--secondary-color);
    background: #fff;
  }

  .qtyCell {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 5px;
  }
  .qtyCell input {
    flex-shrink: 0;
  }
  .printOnly {
    display: none;
  }

  .printMode input {
    display: none !important;
  }
  .printMode .printOnly {
    display: inline !important;
  }

  .printMode #devisBody button {
    display: none !important;
  }
  .printMode #devisBody table tbody td:nth-child(5),
  .printMode #devisBody table thead th:nth-child(5) {
    display: none !important;
  }

  #devisBody button {
    background-color: var(--primary-color);
    color: white;
    width: 28px;
    height: 28px;
    font-size: 1.1rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    line-height: 1;
    user-select: none;
    padding: 0;
  }
  #devisBody button:hover {
    background-color: #0f2a43;
  }

#totalsTable table {
  width: 100%;
  table-layout: fixed; /* important */
}

#totalsTable th:nth-child(1),
#totalsTable td:nth-child(1) {
  width: 35%;  /* Largeur Total HT (€) */
}

#totalsTable th:nth-child(2),
#totalsTable td:nth-child(2) {
  width: 5%;  /* Largeur Remise (%) */
}

#totalsTable th:nth-child(3),
#totalsTable td:nth-child(3) {
  width: 5%;  /* Largeur Remise (€) */
}

#totalsTable th:nth-child(4),
#totalsTable td:nth-child(4) {
  width: 7%;  /* Largeur Total TVA (€) */
}

#totalsTable th:nth-child(5),
#totalsTable td:nth-child(5) {
  width: 7%;  /* Largeur Total TTC (€) */
}


  #totalsTable table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    background: white;
    table-layout: fixed;
  }

  #totalsTable thead th {
    background-color: var(--primary-color);
    color: white;
    font-weight: 700;
    text-align: left;
    padding: 6px 10px;
    white-space: nowrap;
  }

  #totalsTable tbody td {
    padding: 6px 10px;
    text-align: right;
    font-weight: 600;
    vertical-align: middle;
  }

  #totalsTable tbody td:first-child {
    text-align: left;
    font-weight: 700;
  }

  #totalsTable input[type="number"] {
    width: 60px;
    text-align: right;
    font-size: 11px;
    padding: 2px 4px;
    border-radius: 3px;
    border: 1px solid #cfdde9;
  }
  #totalsTable input[type="number"]:focus {
    border-color: var(--secondary-color);
    outline: none;
  }

  .printMode #remisePercent {
    display: none !important;
  }
  .printMode #remisePercentText {
    display: inline !important;
    font-weight: 600;
    color: var(--text-color);
  }
  #remisePercentText {
    display: none;
  }

  #signatureWrapper > div {
    display: flex;
    gap: 15px;
    align-items: flex-start;
    border: 1.5px solid var(--primary-color);
    border-radius: 8px;
    padding: 8px 12px;
    background: #f9f9f9;
    max-width: 100%;
    box-sizing: border-box;
  }
  #signatureBubble {
    flex: 1;
    font-size: 0.9rem;
    line-height: 1.2;
    color: var(--text-light);
    white-space: pre-wrap;
    user-select: text;
    border: none;
    padding: 0;
    margin: 0;
  }
  #signatureImage {
    max-width: 200px;
    max-height: 100px;
    user-select: none;
    pointer-events: none;
    display: block;
    border: none;
    border-radius: 4px;
    object-fit: contain;
  }

  #signatureCanvasWrapper {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 12px;
  }
  #signatureCanvas {
    border: 1px solid #ccc;
    border-radius: 4px;
    touch-action: none;
    width: 320px;
    height: 100px;
  }
.articleContainer {
  margin-bottom: 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #fafafa;
  user-select: text;
}
.articleLine {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0px 0px;      /* padding vertical plus grand => ligne plus haute */
  cursor: pointer;
  user-select: none;
  /* background: #cce4f7;     fond bleu clair */
  /* border-radius: 6px 6px 0 0; */
  font-weight: 700;
  color: var(--primary-color);
  font-size: 0.1rem;       /* texte plus grand */
  min-height: 20px;        /* hauteur minimale pour la ligne */
}

.articleLine .infoBadge {
  background-color: #2874a6;
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 12px;
  margin-left: 6px;
  user-select: none;
  cursor: default;
  white-space: nowrap;
  align-self: center;
}


.articleLine:hover {
  background: #d3e1fa;
}
.articleLine > .refLabel {
  /* background-color: var(--primary-color); */
  /* color: white; */
  padding: 10px 20px;  /* padding plus grand pour augmenter la hauteur */
  border-radius: 8px;
  min-width: 100px;
  text-align: center;
  font-size: 1rem;  /* augmente la taille du texte */
  font-weight: 200;
  user-select: text;
  line-height: 1;
}
.articleLine > button {
  width: 40px;            /* boutons plus gros */
  height: 36px;
  font-weight: 700;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  user-select: none;
  transition: background-color 0.3s ease;
  font-size: 0.01rem;      /* texte plus grand dans les boutons */
}
.articleLine > button:hover,
.articleLine > button:focus {
  background: #0f2a43;
  outline: none;
}
.articleEditPanel {
  padding: 11px 16px 15px 16px;
  background: #fff;
  border-top: 1px solid #ccc;
  border-radius: 0 0 6px 6px;
  display: none;
  user-select: text;
}
.articleEditPanel textarea {
  width: 100%;
  font-size: 0.9rem;
  resize: vertical;
  min-height: 60px;
  padding: 6px 8px;
  border-radius: 5px;
  border: 1.4px solid #ccc;
  margin-bottom: 9px;
  box-sizing: border-box;
  font-family: var(--font-family);
}
.articleEditPanel .inputsRow {
  display: flex;
  gap: 12px;
}
.articleEditPanel .inputsRow input {
  font-size: 0.9rem;
  padding: 6px 8px;
  border-radius: 5px;
  border: 1.4px solid #ccc;
  width: 100px;
  box-sizing: border-box;
  font-family: var(--font-family);
}

  @media (max-width: 960px) {
    #container {
      flex-direction: column;
      max-width: 95%;
    }
    #configPanel {
      width: 100%;
      max-height: none;
      margin-bottom: 25px;
    }
    #devisContainer {
      width: 100%;
      max-width: 100%;
    }
    #signatureCanvasWrapper {
      justify-content: center;
    }
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div id="container">
  <aside id="configPanel" aria-label="Configuration complète du devis">
    <section id="sectionHeader" class="collapsed">
      <h2>Entête du devis</h2>
      <label for="logoFile" style="margin-top: 15px; font-weight: 600;">Importer un logo (PNG/JPG/SVG)</label>
      <input type="file" id="logoFile" accept="image/png, image/jpeg, image/svg+xml" />

      <label><input type="checkbox" id="showLogo" checked /> Afficher le logo</label>

      <label for="devisTitle">Titre du document</label>
      <input type="text" id="devisTitle" value="DEVIS" />
      <label for="companyName">Nom de l'entreprise</label>
      <input type="text" id="companyName" value="Mon Entreprise SARL" />
      <label for="companyAddress">Adresse</label>
      <input type="text" id="companyAddress" value="123 Rue de l'Exemple, 75000 Paris" />
      <label for="companyPhone">Téléphone</label>
      <input type="text" id="companyPhone" value="01 23 45 67 89" />
      <label for="companyEmail">Email</label>
      <input type="text" id="companyEmail" value="contact@monentreprise.fr" />
      <label for="companySiret">SIRET</label>
      <input type="text" id="companySiret" value="123 456 789 00012" />
      <label for="companyTva">TVA Intracom</label>
      <input type="text" id="companyTva" value="FR12345678901" />
    </section>

    <section id="sectionClient" class="collapsed">
      <h2>Informations client</h2>
      <label for="clientLastName">Nom</label>
      <input type="text" id="clientLastName" placeholder="Nom" />
      <label for="clientFirstName">Prénom</label>
      <input type="text" id="clientFirstName" placeholder="Prénom" />
      <label for="clientAddress">Adresse</label>
      <input type="text" id="clientAddress" placeholder="Adresse complète" />
      <label for="clientPostalCode">Code postal</label>
      <input type="text" id="clientPostalCode" placeholder="Code postal" />
      <label for="clientCity">Ville</label>
      <input type="text" id="clientCity" placeholder="Ville" />
      <label for="clientEmail">Email</label>
      <input type="email" id="clientEmail" placeholder="Email" />
      <label for="clientPhone">Téléphone</label>
      <input type="text" id="clientPhone" placeholder="Numéro de téléphone" />
      <label for="date">Date</label>
      <input type="date" id="date" />
      <label for="thankYouMsg" style="margin-top: 15px;">Message de remerciement</label>
      <textarea id="thankYouMsg" rows="4" style="width: 100%; padding:8px; font-size:14px; border-radius:4px;">Merci pour votre confiance.
Ce devis est valable 30 jours à partir de la date d'émission.</textarea>
    </section>

<section id="sectionOptionsAffichage" class="collapsed">
  <h2>Options d'affichage</h2>
  <label><input type="checkbox" id="showDevisTitle" checked /> Afficher le titre du devis</label>
  <label><input type="checkbox" id="showCompanyName" checked /> Afficher le nom de l'entreprise</label>
  <label><input type="checkbox" id="showCompanyAddress" checked /> Afficher l'adresse de l'entreprise</label>
  <label><input type="checkbox" id="showCompanyPhone" checked /> Afficher le téléphone de l'entreprise</label>
  <label><input type="checkbox" id="showCompanyEmail" checked /> Afficher l'email de l'entreprise</label>
  <label><input type="checkbox" id="showCompanySiret" checked /> Afficher le SIRET</label>
  <label><input type="checkbox" id="showCompanyTva" checked /> Afficher la TVA intracom</label>
  <hr>
  <label><input type="checkbox" id="showClientName" checked /> Afficher le nom complet du client</label>
  <label><input type="checkbox" id="showClientAddress" checked /> Afficher l'adresse client</label>
  <label><input type="checkbox" id="showClientPostalCity" checked /> Afficher code postal et ville client</label>
  <label><input type="checkbox" id="showClientEmail" checked /> Afficher l'email client</label>
  <label><input type="checkbox" id="showClientPhone" checked /> Afficher le téléphone client</label>
  <label><input type="checkbox" id="showDate" checked /> Afficher la date</label>
</section>


<section id="sectionArticles" class="collapsed">

  <h2>Articles disponibles</h2>
  <div id="articleEditGlobal" style="border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; background: #f0f8ff; border-radius: 6px; display: none;">
  <h3>Édition article</h3>
  <label>Désignation :</label><br />
  <textarea id="globalDesc" rows="3" style="width: 100%;"></textarea><br />
  <label>Prix HT (€) :</label>
  <input type="number" id="globalPrice" step="0.01" min="0" style="width: 120px;" />
  <label>TVA (%) :</label>
  <input type="number" id="globalTva" step="0.01" min="0" max="100" style="width: 80px;" />
  <button id="saveGlobalEditBtn" style="margin-top: 10px;">Enregistrer</button>
</div>
 <!-- BULLE D'INFO INSÉRÉE ICI -->
  <div id="globalInfoBubble" style="display:none;"></div>

  <form id="addArticleForm" spellcheck="false" aria-label="Formulaire d'ajout d'article">
 
  <div id="articlesList" aria-label="Liste des articles disponibles"></div>
  
  <h3 style="margin: 10px 0 6px 0;">Ajouter un nouvel article</h3>
  <form id="addArticleForm" spellcheck="false" aria-label="Formulaire d'ajout d'article">
    <label for="newDesc">Désignation :</label>
    <textarea id="newDesc" required rows="3" style="width:100%; resize: vertical;" placeholder="Nom de l'article"></textarea>
    <label for="newPrice">Prix unitaire HT (€) :</label>
    <input type="number" id="newPrice" required min="0" step="0.01" placeholder="Ex: 25.50" />
    <label for="newTva">TVA (%) :</label>
    <input type="number" id="newTva" required min="0" max="100" step="0.01" placeholder="20" value="20" />
    <label for="newInfo">Info (optionnel) :</label>
  <input type="text" id="newInfo" placeholder="Note ou info rapide" style="width: 100%; margin-bottom: 10px;" />


    <button type="submit" id="addArticleBtn">Ajouter l'article</button>
  </form>
</section>

    <section id="sectionSignature" class="collapsed">
      <h2>Signature</h2>
      <label><input type="checkbox" id="showSignatureBubble" checked /> Afficher la bulle texte</label>
      <label><input type="checkbox" id="showSignatureImage" checked /> Afficher la signature manuscrite (canvas + image)</label>

      <label for="signatureTextArea" style="margin-top:10px;">Texte de signature</label>
      <textarea id="signatureTextArea" rows="5" style="width:100%; resize: vertical;">Fait à __VILLE__, le __DATE__

Bon pour accord,

Signature et cachet</textarea>
      <div id="autoDateInfo" style="font-size: 0.8rem; color: var(--text-light); margin-top: 5px;">Le token <code>__DATE__</code> sera remplacé automatiquement par la date du jour.</div>

      <h3 style="margin-top: 12px;">Options d'autonomie</h3>
      <label><input type="checkbox" id="autoDateCheckbox" /> Date automatique (remplace <code>__DATE__</code> dans le texte)</label>
      <label><input type="checkbox" id="lockSignatureCheckbox" /> Verrouiller la zone signature (lecture seule)</label>

      <label for="signatureFile" style="margin-top: 10px; font-weight: 600;">Importer une image de signature</label>
      <input type="file" id="signatureFile" accept="image/png, image/jpeg" />

      <div id="signatureCanvasWrapper">
        <canvas id="signatureCanvas" width="320" height="100"></canvas>
        <button id="clearSignatureBtn" type="button">Effacer la signature</button>
      </div>
    </section>


<section>
  <h2>Export / Import configuration</h2>

  <label for="fileNameInput" style="display:block; margin-bottom: 6px; font-weight: 600;">
    Nom du fichier à exporter :
  </label>
  <input type="text" id="fileNameInput" placeholder="exemple_devis" style="width: 100%; padding: 6px; margin-bottom: 12px; box-sizing: border-box;" />

  <div style="display:flex; gap:8px; flex-wrap: wrap;">
    <button id="btnExportTxt" style="flex-grow:1;">Exporter config en TXT</button>
    <input type="file" id="fileImportTxt" accept=".txt,text/plain" style="flex-grow:1;" />
    <button id="btnExportPDF" style="flex-grow:1;">Exporter en PDF</button>
  </div>
</section>

    </section>
  </aside>

  <main id="devisContainer" role="main" aria-label="Feuille de devis éditable" style="flex-grow: 1;">
    <div id="devisHeader" aria-label="En-tête du devis" spellcheck="false">
<div id="logoContainer">
  <img id="logoImage" alt="Logo" />
</div>

      <div id="headerLeft">
        <h2 id="devisTitleDisplay">DEVIS</h2>


        
        <strong id="companyNameDisplay">Mon Entreprise SARL</strong>
        <div id="companyAddressDisplay">123 Rue de l'Exemple, 75000 Paris</div>
        <div id="companyPhoneDisplay">01 23 45 67 89</div>
        <div id="companyEmailDisplay">contact@monentreprise.fr</div>
        <div id="companySiretDisplay">123 456 789 00012</div>
        <div id="companyTvaDisplay">FR12345678901</div>
      </div>
      <div id="headerRight" aria-label="Date du devis" style="font-weight: 700; font-size: 14px; color: var(--text-color); white-space: nowrap; text-align: right;">
        <div id="dateDisplay">Date : 05/06/2025</div>

        <!-- Infos client déplacées ici sous la date -->
        <div id="clientInfo" aria-label="Informations client">
          
          <p><span class="clientLabel"></span><span id="clientNameDisplay"></span></p>
          <p><span class="clientLabel"></span><span id="clientAddressDisplay"></span></p>
          <p><span class="clientLabel"></span><span id="clientPostalCityDisplay"></span></p>
          <p><span class="clientLabel"></span><span id="clientEmailDisplay"></span></p>
          <p><span class="clientLabel"></span><span id="clientPhoneDisplay"></span></p>
        </div>
      </div>
    </div>

    <div id="devisTablesWrapper">
      <div id="devisBody" spellcheck="false" aria-label="Tableau des articles du devis">
        <table>
          <thead>
            <tr>
              <th>Désignation</th>
              <th>Qté/Tps</th>
              <th>Prix UT</th>
              <th>M HT</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="totalsTable">
        <table>
          <thead>
            <tr>
              <th>Total HT (€)</th>
              <th>Remise (%)</th>
              <th>Remise (€)</th>
              <th>Total TVA (€)</th>
              <th>Total TTC (€)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="totalHTValue">0.00 €</td>
              <td>
                <input type="number" id="remisePercent" min="0" max="100" step="0.1" value="0" style="width:60px; text-align:right;" /> 
                <span id="remisePercentText" class="printOnly"></span>%
              </td>
              <td id="remiseValue">0.00 €</td>
              <td id="totalTVAValue">0.00 €</td>
              <td id="totalTTCValue">0.00 €</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="signatureWrapper"></div>
    </div>

    <div id="devisFooter" aria-label="Message de fin de devis" spellcheck="false" style="
      margin-top: 25px; 
      font-size: 0.8rem; 
      color: var(--text-light); 
      line-height: 1.4; 
      white-space: pre-line;
      user-select: text;
    ">
      Merci pour votre confiance.<br />Ce devis est valable 30 jours à partir de la date d'émission.
    </div>
  </main>
</div>

<script>
  // DOM elements
  const devisHeader = document.getElementById('devisHeader');
  const newInfoInput = document.getElementById('newInfo');

  const devisTitleInput = document.getElementById('devisTitle');
  const companyNameInput = document.getElementById('companyName');
  const companyAddressInput = document.getElementById('companyAddress');
  const companyPhoneInput = document.getElementById('companyPhone');
  const companyEmailInput = document.getElementById('companyEmail');
  const companySiretInput = document.getElementById('companySiret');
  const companyTvaInput = document.getElementById('companyTva');

  const clientLastNameInput = document.getElementById('clientLastName');
  const clientFirstNameInput = document.getElementById('clientFirstName');
  const clientAddressInput = document.getElementById('clientAddress');
  const clientPostalCodeInput = document.getElementById('clientPostalCode');
  const clientCityInput = document.getElementById('clientCity');
  const clientEmailInput = document.getElementById('clientEmail');
  const clientPhoneInput = document.getElementById('clientPhone');

  const dateInput = document.getElementById('date');
  const thankYouMsgInput = document.getElementById('thankYouMsg');
  const articlesList = document.getElementById('articlesList');
  const addArticleForm = document.getElementById('addArticleForm');

  // Au chargement, créer le conteneur de la bulle au-dessus du formulaire d'ajout

const addArticleTitle = Array.from(document.querySelectorAll('#sectionArticles h3'))
  .find(h3 => h3.textContent.trim() === 'Ajouter un nouvel article');

let globalInfoBubble = document.createElement('div');
globalInfoBubble.id = 'globalInfoBubble';
globalInfoBubble.style.background = '#2874a6';
globalInfoBubble.style.color = 'white';
globalInfoBubble.style.padding = '10px 14px';
globalInfoBubble.style.borderRadius = '8px';
globalInfoBubble.style.marginBottom = '10px';
globalInfoBubble.style.fontSize = '0.9rem';
globalInfoBubble.style.display = 'none';
globalInfoBubble.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
globalInfoBubble.setAttribute('role', 'alert');
globalInfoBubble.setAttribute('aria-live', 'polite');

if(addArticleTitle) {
  addArticleTitle.parentNode.insertBefore(globalInfoBubble, addArticleTitle);
}

  const newDescInput = document.getElementById('newDesc');
  const newPriceInput = document.getElementById('newPrice');
  const newTvaInput = document.getElementById('newTva');
  const tbody = document.querySelector('#devisBody tbody');
  const fileNameInput = document.getElementById('fileNameInput');
  const btnExportTxt = document.getElementById('btnExportTxt');
  const fileImportTxt = document.getElementById('fileImportTxt');
  const btnExportPDF = document.getElementById('btnExportPDF');
  const remiseInput = document.getElementById('remisePercent');
  const remiseValueDisplay = document.getElementById('remiseValue');
  const remisePercentText = document.getElementById('remisePercentText');
  const devisFooter = document.getElementById('devisFooter');

  const companyNameDisplay = document.getElementById('companyNameDisplay');
  const companyAddressDisplay = document.getElementById('companyAddressDisplay');
  const companyPhoneDisplay = document.getElementById('companyPhoneDisplay');
  const companyEmailDisplay = document.getElementById('companyEmailDisplay');
  const companySiretDisplay = document.getElementById('companySiretDisplay');
  const companyTvaDisplay = document.getElementById('companyTvaDisplay');
  const dateDisplay = document.getElementById('dateDisplay');

  // Infos client dans le header (maintenant dans #devisHeader #clientInfo)
  const clientNameDisplay = document.querySelector('#clientInfo #clientNameDisplay');
  const clientAddressDisplay = document.querySelector('#clientInfo #clientAddressDisplay');
  const clientPostalCityDisplay = document.querySelector('#clientInfo #clientPostalCityDisplay');
  const clientEmailDisplay = document.querySelector('#clientInfo #clientEmailDisplay');
  const clientPhoneDisplay = document.querySelector('#clientInfo #clientPhoneDisplay');

  // Signature elements & options
  const signatureWrapper = document.getElementById('signatureWrapper');
  const signatureCanvasWrapper = document.getElementById('signatureCanvasWrapper');
  const signatureCanvas = document.getElementById('signatureCanvas');
  const clearSignatureBtn = document.getElementById('clearSignatureBtn');
  const signatureTextArea = document.getElementById('signatureTextArea');
  const autoDateCheckbox = document.getElementById('autoDateCheckbox');
  const lockSignatureCheckbox = document.getElementById('lockSignatureCheckbox');
  const autoDateInfo = document.getElementById('autoDateInfo');
  const signatureFileInput = document.getElementById('signatureFile');

  const showSignatureBubble = document.getElementById('showSignatureBubble');
  const showSignatureImage = document.getElementById('showSignatureImage');

  // Articles and devis items
  let articles = [
    { desc: "Consultation", price: 50.00, tva: 20 },
    { desc: "Développement Web", price: 80.00, tva: 20 },
  ];
  let devisItems = [];

  // Signature dynamic elements in devis (non editable bubble + image)
  let signatureBubbleDiv = null;
  let signatureImageElement = null;

  // === Fonctions de mise à jour ===

function updateDevisHeader() {
  companyNameDisplay.textContent = companyNameInput.value || '';
  companyAddressDisplay.textContent = companyAddressInput.value || '';
  companyPhoneDisplay.textContent = companyPhoneInput.value || '';
  companyEmailDisplay.textContent = companyEmailInput.value || '';
  companySiretDisplay.textContent = companySiretInput.value || '';
  companyTvaDisplay.textContent = companyTvaInput.value || '';
  devisTitleDisplay.textContent = devisTitleInput.value || '';

  if (showLogoCheckbox.checked && logoImage.src) {
    logoImage.style.display = 'block';
    devisHeader.classList.add('withLogo');
    devisHeader.classList.remove('noLogo');
  } else {
    logoImage.style.display = 'none';
    devisHeader.classList.add('noLogo');
    devisHeader.classList.remove('withLogo');
  }
}



  function updateClientInfo() {
    let fullName = (clientFirstNameInput.value + ' ' + clientLastNameInput.value).trim();
    clientNameDisplay.textContent = fullName || '';
    clientAddressDisplay.textContent = clientAddressInput.value || '';
    let postalCity = '';
    if(clientPostalCodeInput.value) postalCity += clientPostalCodeInput.value;
    if(clientCityInput.value) postalCity += (postalCity ? ' ' : '') + clientCityInput.value;
    clientPostalCityDisplay.textContent = postalCity;
    clientEmailDisplay.textContent = clientEmailInput.value || '';
    clientPhoneDisplay.textContent = clientPhoneInput.value || '';
  }

  function updateDevisFooter() {
    devisFooter.innerHTML = thankYouMsgInput.value || "Merci pour votre confiance.\nCe devis est valable 30 jours à partir de la date d'émission.";
  }

  function applyAutoDate(text) {
    if (!autoDateCheckbox.checked) return text;
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const formattedDate = `${dd}/${mm}/${yyyy}`;
    return text.replace(/__DATE__/g, formattedDate);
  }

  // === Gestion visibilité infos client selon options ===
  // Récupérer l'état des cases à cocher

function updateClientInfoVisibility() {
  
    const showDevisTitle = document.getElementById('showDevisTitle').checked;
  const showCompanyName = document.getElementById('showCompanyName').checked;
  const showCompanyAddress = document.getElementById('showCompanyAddress').checked;
  const showCompanyPhone = document.getElementById('showCompanyPhone').checked;
  const showCompanyEmail = document.getElementById('showCompanyEmail').checked;
  const showCompanySiret = document.getElementById('showCompanySiret').checked;
  const showCompanyTva = document.getElementById('showCompanyTva').checked;

  // Appliquer la visibilité en fonction des options sélectionnées
  const companyNameElem = document.getElementById('companyNameDisplay');
  const companyAddressElem = document.getElementById('companyAddressDisplay');
  const companyPhoneElem = document.getElementById('companyPhoneDisplay');
  const companyEmailElem = document.getElementById('companyEmailDisplay');
  const companySiretElem = document.getElementById('companySiretDisplay');
  const companyTvaElem = document.getElementById('companyTvaDisplay');
  const devisTitleElem = document.getElementById('devisTitleDisplay');

  companyNameElem.style.display = showCompanyName ? '' : 'none';
  companyAddressElem.style.display = showCompanyAddress ? '' : 'none';
  companyPhoneElem.style.display = showCompanyPhone ? '' : 'none';
  companyEmailElem.style.display = showCompanyEmail ? '' : 'none';
  companySiretElem.style.display = showCompanySiret ? '' : 'none';
  companyTvaElem.style.display = showCompanyTva ? '' : 'none';
  devisTitleElem.style.display = showDevisTitle ? '' : 'none';

  
  
  const showClientName = document.getElementById('showClientName').checked;
  const showClientAddress = document.getElementById('showClientAddress').checked;
  const showClientPostalCity = document.getElementById('showClientPostalCity').checked;
  const showClientEmail = document.getElementById('showClientEmail').checked;
  const showClientPhone = document.getElementById('showClientPhone').checked;
  const showDate = document.getElementById('showDate').checked;

  const clientNameElem = document.getElementById('clientNameDisplay');
  const clientAddressElem = document.getElementById('clientAddressDisplay');
  const clientPostalCityElem = document.getElementById('clientPostalCityDisplay');
  const clientEmailElem = document.getElementById('clientEmailDisplay');
  const clientPhoneElem = document.getElementById('clientPhoneDisplay');
  const dateElem = document.getElementById('dateDisplay');

  // On masque/affiche le <p> parent pour éviter les bugs d'ordre
  clientNameElem.parentElement.style.display = showClientName ? '' : 'none';
  clientAddressElem.parentElement.style.display = showClientAddress ? '' : 'none';
  clientPostalCityElem.parentElement.style.display = showClientPostalCity ? '' : 'none';
  clientEmailElem.parentElement.style.display = showClientEmail ? '' : 'none';
  clientPhoneElem.parentElement.style.display = showClientPhone ? '' : 'none';
  dateElem.style.display = showDate ? '' : 'none';

}

const logoFileInput = document.getElementById('logoFile');
const logoImage = document.getElementById('logoImage');
const showLogoCheckbox = document.getElementById('showLogo');

function updateLogoVisibility() {
  logoImage.style.display = showLogoCheckbox.checked && logoImage.src ? 'block' : 'none';
}

logoFileInput.addEventListener('change', () => {
  const file = logoFileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    logoImage.src = e.target.result;
    updateLogoVisibility();
    saveData(); // Sauvegarde la config avec le logo
  };
  reader.readAsDataURL(file);
  logoFileInput.value = '';
});

showLogoCheckbox.addEventListener('change', () => {
  updateLogoVisibility();
  saveData();
});

// Dans ta fonction saveData() ajoute :
function saveData() {
  // ... ton code actuel ...
  const data = {
    // ... autres données ...
    logoImageData: logoImage.src || '',
    showLogo: showLogoCheckbox.checked,
  };
  localStorage.setItem('devisData', JSON.stringify(data));
}

// Dans ta fonction restoreData() ajoute :
function restoreData() {
  const str = localStorage.getItem('devisData');
  if (!str) return;
  try {
    const data = JSON.parse(str);
    // ... restauration autres champs ...

    if (data.logoImageData) {
      logoImage.src = data.logoImageData;
    } else {
      logoImage.src = '';
    }

    if (typeof data.showLogo === 'boolean') {
      showLogoCheckbox.checked = data.showLogo;
    }

    updateLogoVisibility();

  } catch (e) {
    console.error('Erreur restauration données :', e);
  }
}

// Appelle restoreData() au chargement initial de la page
window.addEventListener('DOMContentLoaded', () => {
  restoreData();
  // ... autres initialisations ...
});

  // === Gestion signature ===

  function renderSignatureArea() {
    signatureWrapper.innerHTML = '';

    const showBubble = showSignatureBubble.checked;
    const showImage = showSignatureImage.checked;

    signatureCanvasWrapper.style.display = showImage ? 'flex' : 'none';

    if (!showBubble && !showImage) return;

    const container = document.createElement('div');
    container.id = 'signatureWrapperContainer';
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.gap = '8px';

    const signatureCaption = document.createElement('div');
    signatureCaption.textContent = 'Signature et cachet';
    signatureCaption.style.fontWeight = '600';
    signatureCaption.style.color = 'var(--text-light)';
    container.appendChild(signatureCaption);

    const signatureContent = document.createElement('div');
    signatureContent.style.display = 'flex';
    signatureContent.style.gap = '15px';
    signatureContent.style.alignItems = 'flex-start';

    if (showBubble) {
      if (!signatureBubbleDiv) {
        signatureBubbleDiv = document.createElement('div');
        signatureBubbleDiv.id = 'signatureBubble';
        signatureBubbleDiv.contentEditable = false;
        signatureBubbleDiv.setAttribute('aria-label', 'Espace signature');
        signatureBubbleDiv.spellcheck = false;
        signatureBubbleDiv.style.userSelect = 'text';
      }
      let sigText = applyAutoDate(signatureTextArea.value);
      signatureBubbleDiv.textContent = sigText;
      signatureContent.appendChild(signatureBubbleDiv);
    }

    if (showImage) {
      if (!signatureImageElement) {
        signatureImageElement = document.createElement('img');
        signatureImageElement.id = 'signatureImage';
        signatureImageElement.alt = 'Image de signature manuscrite';
        signatureImageElement.style.display = 'none';
      }
      signatureContent.appendChild(signatureImageElement);
    }

    container.appendChild(signatureContent);
    signatureWrapper.appendChild(container);
  }

  function saveData() {
    const data = {
      headerForm: {
        devisTitle: devisTitleInput.value,
        companyName: companyNameInput.value,
        companyAddress: companyAddressInput.value,
        companyPhone: companyPhoneInput.value,
        companyEmail: companyEmailInput.value,
        companySiret: companySiretInput.value,
        companyTva: companyTvaInput.value,
      },
      clientForm: {
        clientLastName: clientLastNameInput.value,
        clientFirstName: clientFirstNameInput.value,
        clientAddress: clientAddressInput.value,
        clientPostalCode: clientPostalCodeInput.value,
        clientCity: clientCityInput.value,
        clientEmail: clientEmailInput.value,
        clientPhone: clientPhoneInput.value,
        date: dateInput.value,
        thankYouMsg: thankYouMsgInput.value,
      },
      displayOptions: {
        showDevisTitle: document.getElementById('showDevisTitle').checked,
        showCompanyName: document.getElementById('showCompanyName').checked,
        showCompanyAddress: document.getElementById('showCompanyAddress').checked,
        showCompanyPhone: document.getElementById('showCompanyPhone').checked,
        showCompanyEmail: document.getElementById('showCompanyEmail').checked,
        showCompanySiret: document.getElementById('showCompanySiret').checked,
        showCompanyTva: document.getElementById('showCompanyTva').checked,
        showClientName: document.getElementById('showClientName').checked,
        showClientAddress: document.getElementById('showClientAddress').checked,
        showClientPostalCity: document.getElementById('showClientPostalCity').checked,
        showClientEmail: document.getElementById('showClientEmail').checked,
        showClientPhone: document.getElementById('showClientPhone').checked,
        showDate: document.getElementById('showDate').checked,
      },
      articles,
      devisItems,
      remisePercent: remiseInput.value,
      thankYouMsg: thankYouMsgInput.value,
      signatureText: signatureTextArea.value,
      signatureOptions: {
        autoDate: autoDateCheckbox.checked,
        lockSignature: lockSignatureCheckbox.checked,
        showSignatureBubble: showSignatureBubble.checked,
        showSignatureImage: showSignatureImage.checked,
      },
      signatureImageData: signatureCanvas.toDataURL('image/png'),
    };
    localStorage.setItem('devisData', JSON.stringify(data));
  }

  function restoreData() {
    const str = localStorage.getItem('devisData');
    if (!str) return;
    try {
      const data = JSON.parse(str);
      Object.entries(data.headerForm || {}).forEach(([k, v]) => {
        const el = document.getElementById(k);
        if (el) el.value = v;
      });
      Object.entries(data.clientForm || {}).forEach(([k, v]) => {
        const el = document.getElementById(k);
        if (el) el.value = v;
      });
      if (data.displayOptions) {
        Object.entries(data.displayOptions).forEach(([k, v]) => {
          const el = document.getElementById(k);
          if (el && typeof v === 'boolean') el.checked = v;
        });
      }
      if (Array.isArray(data.articles)) articles = data.articles;
      if (Array.isArray(data.devisItems)) devisItems = data.devisItems;
      if (data.remisePercent !== undefined) {
        remiseInput.value = data.remisePercent;
      }
      if (data.thankYouMsg !== undefined) {
        thankYouMsgInput.value = data.thankYouMsg;
      }
      if (data.signatureText !== undefined) {
        signatureTextArea.value = data.signatureText;
      }
      if (data.signatureOptions) {
        autoDateCheckbox.checked = !!data.signatureOptions.autoDate;
        lockSignatureCheckbox.checked = !!data.signatureOptions.lockSignature;
        showSignatureBubble.checked = !!data.signatureOptions.showSignatureBubble;
        showSignatureImage.checked = !!data.signatureOptions.showSignatureImage;
      }
      if (data.signatureImageData) {
        const img = new Image();
        img.onload = () => {
          const ctx = signatureCanvas.getContext('2d');
          ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
          ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
          if(signatureImageElement) {
            signatureImageElement.src = data.signatureImageData;
            signatureImageElement.style.display = 'block';
          }
        };
        img.src = data.signatureImageData;
      }
      updateAutoDateInfoVisibility();
      updateSignatureLock();
      renderSignatureArea();
      updateDevisHeader();
      updateClientInfo();
      updateClientInfoVisibility(); // <-- applique la visibilité des infos client selon options
      updateDevisFooter();
      renderArticles();
      updateDevisTable();
    } catch (e) {
      console.error('Erreur restauration données :', e);
    }
  }

  // === Gestion articles ===

let currentEditingIndex = null;

function renderArticles() {
  articlesList.innerHTML = '';
  articles.forEach((art, i) => {
    const container = document.createElement('div');
    container.className = 'articleContainer';

    const line = document.createElement('div');
    line.className = 'articleLine';

    const refLabel = document.createElement('span');
    refLabel.className = 'refLabel';
    refLabel.textContent = `Ref ${String(i + 1).padStart(4, '0')}`;

    // Création de la bulle d'info liée au bouton infoBadge
    const infoBubble = document.createElement('div');
    infoBubble.style.position = 'absolute';
    infoBubble.style.background = '#2874a6';
    infoBubble.style.color = 'white';
    infoBubble.style.padding = '6px 10px';
    infoBubble.style.borderRadius = '6px';
    infoBubble.style.whiteSpace = 'normal';
    infoBubble.style.fontSize = '0.85rem';
    infoBubble.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
    infoBubble.style.zIndex = '10';
    infoBubble.style.display = 'none';
    infoBubble.textContent = art.info || 'Pas d\'info';

    // Position relative sur line pour placer bulle par rapport au bouton
    line.style.position = 'relative';

    const btnAdd = document.createElement('button');
    btnAdd.type = 'button'; 
    btnAdd.textContent = '+';
    btnAdd.title = 'Ajouter au devis';
    btnAdd.addEventListener('click', e => {
      e.stopPropagation();
      addItemToDevis(1, art.price, art.tva, art.desc);
    });

    const btnRemove = document.createElement('button');
    btnRemove.textContent = '×';
    btnRemove.title = 'Supprimer article';
    btnRemove.addEventListener('click', e => {
      e.stopPropagation();
      if(confirm(`Supprimer l'article "${art.desc}" ?`)) {
        articles.splice(i, 1);
        renderArticles();
        updateDevisTable();
        saveData();
        hideGlobalEditor();
      }
    });

   // ...

const infoBadge = document.createElement('button'); // bouton au lieu de span
infoBadge.className = 'infoBadge';
infoBadge.textContent = 'i';
infoBadge.title = art.info || 'Pas d\'info';

infoBadge.style.width = '40px';
infoBadge.style.height = '36px';
infoBadge.style.fontWeight = '700';
infoBadge.style.backgroundColor = 'var(--primary-color)';
infoBadge.style.color = 'white';
infoBadge.style.border = 'none';
infoBadge.style.borderRadius = '6px';
infoBadge.style.cursor = art.info ? 'pointer' : 'default';
infoBadge.style.userSelect = 'none';
infoBadge.style.transition = 'background-color 0.3s ease';
infoBadge.style.fontSize = '1.2rem'; // taille du texte visible

infoBadge.addEventListener('mouseover', () => {
  infoBadge.style.backgroundColor = '#0f2a43';
});
infoBadge.addEventListener('mouseout', () => {
  infoBadge.style.backgroundColor = 'var(--primary-color)';
});

// Même gestion du clic que précédemment
infoBadge.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();

  const infoText = art.info || 'Pas d\'info disponible.';
  const htmlWithBreaks = infoText.replace(/\n/g, '<br>');

  if(globalInfoBubble.style.display === 'none' || globalInfoBubble.innerHTML !== htmlWithBreaks) {
    globalInfoBubble.innerHTML = htmlWithBreaks;  // ici juste le contenu, sans titre
    globalInfoBubble.style.display = 'block';
    globalInfoBubble.scrollIntoView({behavior: 'smooth', block: 'center'});
  } else {
    globalInfoBubble.style.display = 'none';
  }
});




    // Ajouter une classe pour cibler facilement les bulles
    infoBubble.classList.add('infoBubble');

    // Clic ailleurs ferme toutes les bulles
    document.addEventListener('click', () => {
  globalInfoBubble.style.display = 'none';
    });

    line.appendChild(refLabel);
    line.appendChild(btnAdd);
    line.appendChild(btnRemove);
    line.appendChild(infoBadge);
    line.appendChild(infoBubble);

    // Au clic sur la ligne, affiche l'éditeur global
    line.addEventListener('click', () => {
      currentEditingIndex = i;
      showGlobalEditor(art);
    });

    container.appendChild(line);
    articlesList.appendChild(container);
  });
}


// Affiche le bloc global et remplit les champs
function showGlobalEditor(article) {
  document.getElementById('articleEditGlobal').style.display = 'block';
  document.getElementById('globalDesc').value = article.desc;
  document.getElementById('globalPrice').value = article.price.toFixed(2);
  document.getElementById('globalTva').value = article.tva;
}

// Cache le bloc global
function hideGlobalEditor() {
  document.getElementById('articleEditGlobal').style.display = 'none';
  currentEditingIndex = null;
}

// Sauvegarde les modifications du bloc global dans l'article correspondant
document.getElementById('saveGlobalEditBtn').addEventListener('click', () => {
  if(currentEditingIndex === null) return;
  const desc = document.getElementById('globalDesc').value.trim();
  const price = parseFloat(document.getElementById('globalPrice').value);
  const tva = parseFloat(document.getElementById('globalTva').value);
  if(!desc || isNaN(price) || isNaN(tva)) {
    alert('Veuillez remplir tous les champs correctement.');
    return;
  }
  articles[currentEditingIndex].desc = desc;
  articles[currentEditingIndex].price = price;
  articles[currentEditingIndex].tva = tva;
  saveData();
  renderArticles();
  hideGlobalEditor();
});


  function addItemToDevis(qty, price, tva, desc) {
    const existing = devisItems.find(item => item.desc === desc);
    if (existing) {
      existing.qty += qty;
    } else {
      devisItems.push({ qty, price, tva, desc });
    }
    updateDevisTable();
    saveData();
  }

  function updateDevisTable() {
    tbody.innerHTML = '';
    let totalHT = 0;
    let totalTVA = 0;

    devisItems.forEach((item, index) => {
      const tr = document.createElement('tr');

      const tdDesc = document.createElement('td');
      tdDesc.innerHTML = item.desc.replace(/\n/g, '<br>');
      tr.appendChild(tdDesc);

      const tdQty = document.createElement('td');
      tdQty.className = 'qtyCell';
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = 0;
      qtyInput.value = item.qty;
      qtyInput.style.width = '40px';
      qtyInput.addEventListener('change', () => {
        let val = parseInt(qtyInput.value);
        if (isNaN(val) || val < 0) val = 0;
        if (val === 0) {
          devisItems.splice(index, 1);
        } else {
          devisItems[index].qty = val;
        }
        updateDevisTable();
        saveData();
      });
      const qtySpan = document.createElement('span');
      qtySpan.className = 'printOnly';
      qtySpan.textContent = item.qty;
      tdQty.appendChild(qtyInput);
      tdQty.appendChild(qtySpan);
      tr.appendChild(tdQty);

      const tdPrice = document.createElement('td');
      tdPrice.textContent = item.price.toFixed(2);
      tdPrice.style.textAlign = 'right';
      tr.appendChild(tdPrice);

      const netHT = item.qty * item.price;
      const tdNetHT = document.createElement('td');
      tdNetHT.textContent = netHT.toFixed(2);
      tdNetHT.style.textAlign = 'right';
      tr.appendChild(tdNetHT);

      const tdRemove = document.createElement('td');
      tdRemove.style.textAlign = 'center';
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '×';
      removeBtn.title = 'Supprimer une unité de cet article';
      removeBtn.style.backgroundColor = 'var(--primary-color)';
      removeBtn.style.color = 'white';
      removeBtn.style.borderRadius = '4px';
      removeBtn.style.padding = '2px 8px';
      removeBtn.style.fontWeight = 'bold';
      removeBtn.style.border = 'none';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.fontSize = '1.1rem';
      removeBtn.style.lineHeight = '1';
      removeBtn.style.userSelect = 'none';

      removeBtn.addEventListener('click', () => {
        if (devisItems[index].qty > 1) {
          devisItems[index].qty -= 1;
        } else {
          devisItems.splice(index, 1);
        }
        updateDevisTable();
        saveData();
      });

      tdRemove.appendChild(removeBtn);
      tr.appendChild(tdRemove);

      tbody.appendChild(tr);

      totalHT += netHT;
      totalTVA += netHT * (item.tva / 100);
    });

    let remisePercent = parseFloat(remiseInput.value);
    if (isNaN(remisePercent) || remisePercent < 0) remisePercent = 0;
    if (remisePercent > 100) remisePercent = 100;

    const remiseAmount = (totalHT * remisePercent) / 100;
    const totalHTRemise = totalHT - remiseAmount;
    const totalTVARemise = totalHTRemise * (totalHT > 0 ? (totalTVA / totalHT) : 0);
    const totalTTCRemise = totalHTRemise + totalTVARemise;

    remiseValueDisplay.textContent = remiseAmount.toFixed(2) + ' €';
    document.getElementById('totalHTValue').textContent = totalHTRemise.toFixed(2) + ' €';
    document.getElementById('totalTVAValue').textContent = totalTVARemise.toFixed(2) + ' €';
    document.getElementById('totalTTCValue').textContent = totalTTCRemise.toFixed(2) + ' €';

    remisePercentText.textContent = remisePercent.toFixed(1);
  }

  // === Gestion signature canvas ===

  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;
  const ctx = signatureCanvas.getContext('2d');
  ctx.strokeStyle = 'var(--primary-color)';
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';

  function getCanvasPos(e) {
    const rect = signatureCanvas.getBoundingClientRect();
    if (e.touches && e.touches.length > 0) {
      return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
    }
    return [e.clientX - rect.left, e.clientY - rect.top];
  }
  function startDrawing(e) {
    if(lockSignatureCheckbox.checked) return;
    isDrawing = true;
    [lastX, lastY] = getCanvasPos(e);
    e.preventDefault();
  }
  function draw(e) {
    if (!isDrawing) return;
    const [x, y] = getCanvasPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    [lastX, lastY] = [x, y];
    e.preventDefault();
  }
  function stopDrawing(e) {
    if(!isDrawing) return;
    isDrawing = false;
    saveSignatureCanvas();
    e.preventDefault();
  }
  signatureCanvas.addEventListener('mousedown', startDrawing);
  signatureCanvas.addEventListener('touchstart', startDrawing);
  signatureCanvas.addEventListener('mousemove', draw);
  signatureCanvas.addEventListener('touchmove', draw);
  signatureCanvas.addEventListener('mouseup', stopDrawing);
  signatureCanvas.addEventListener('mouseout', stopDrawing);
  signatureCanvas.addEventListener('touchend', stopDrawing);

  clearSignatureBtn.addEventListener('click', () => {
    ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    if(signatureImageElement) {
      signatureImageElement.src = '';
      signatureImageElement.style.display = 'none';
    }
    saveData();
  });

  signatureFileInput.addEventListener('change', () => {
    if (signatureFileInput.files.length === 0) return;
    const file = signatureFileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
        if(signatureImageElement) {
          signatureImageElement.src = e.target.result;
          signatureImageElement.style.display = 'block';
        }
        saveData();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    signatureFileInput.value = '';
  });

  function saveSignatureCanvas() {
    const dataURL = signatureCanvas.toDataURL('image/png');
    if(signatureImageElement) {
      signatureImageElement.src = dataURL;
      signatureImageElement.style.display = 'block';
    }
    saveData();
  }

  function updateSignatureLock() {
    signatureTextArea.readOnly = lockSignatureCheckbox.checked;
    signatureCanvas.style.pointerEvents = lockSignatureCheckbox.checked ? 'none' : 'auto';
    clearSignatureBtn.disabled = lockSignatureCheckbox.checked;
    signatureFileInput.disabled = lockSignatureCheckbox.checked;
  }

  function updateAutoDateInfoVisibility() {
    autoDateInfo.style.display = autoDateCheckbox.checked ? 'block' : 'none';
  }

  // === Synchronisation mise à jour ===

  [
    devisTitleInput, companyNameInput, companyAddressInput, companyPhoneInput, companyEmailInput,
    companySiretInput, companyTvaInput
  ].forEach(input => {
    input.addEventListener('input', () => {
      updateDevisHeader();
      saveData();
    });
  });

  [
    clientLastNameInput, clientFirstNameInput, clientAddressInput, clientPostalCodeInput,
    clientCityInput, clientEmailInput, clientPhoneInput
  ].forEach(input => {
    input.addEventListener('input', () => {
      updateClientInfo();
      saveData();
    });
  });

  dateInput.addEventListener('input', () => {
    updateDevisHeader();
    saveData();
  });

  thankYouMsgInput.addEventListener('input', () => {
    updateDevisFooter();
    saveData();
  });

  Array.from(document.querySelectorAll('#configPanel input[type=checkbox]')).forEach(cb => {
    cb.addEventListener('change', () => {
      updateDevisHeader();
      renderSignatureArea();
      updateClientInfoVisibility(); // <-- ajout ici pour appliquer la visibilité client
      saveData();
    });
  });

  remiseInput.addEventListener('input', () => {
    updateDevisTable();
    saveData();
  });

  showSignatureBubble.addEventListener('change', () => {
    renderSignatureArea();
    saveData();
  });
  showSignatureImage.addEventListener('change', () => {
    renderSignatureArea();
    saveData();
  });

  signatureTextArea.addEventListener('input', () => {
    renderSignatureArea();
    saveData();
  });

  autoDateCheckbox.addEventListener('change', () => {
    updateAutoDateInfoVisibility();
    renderSignatureArea();
    saveData();
  });

  lockSignatureCheckbox.addEventListener('change', () => {
    updateSignatureLock();
    saveData();
  });

  // Formulaire ajout article
addArticleForm.addEventListener('submit', e => {
  e.preventDefault();
  const desc = newDescInput.value.trim();
  const price = parseFloat(newPriceInput.value);
  const tva = parseFloat(newTvaInput.value);
  const info = newInfoInput.value.trim();   // Récupère la nouvelle info

  if(!desc || isNaN(price) || isNaN(tva)) {
    alert('Veuillez remplir correctement tous les champs.');
    return;
  }
  articles.push({ desc, price, tva, info });  // Ajoute info à l'objet article

  renderArticles();

  saveData();
  newDescInput.value = '';
  newPriceInput.value = '';
  newTvaInput.value = '20';
  newInfoInput.value = '';        // Vide le champ info
});


  // Export config TXT
btnExportTxt.addEventListener('click', () => {
  const data = localStorage.getItem('devisData');
  if (!data) {
    alert('Aucune configuration sauvegardée.');
    return;
  }

  // Récupère le nom de fichier dans le champ input
  let fileName = fileNameInput.value.trim();
  if (!fileName) {
    alert('Merci de saisir un nom de fichier');
    return;
  }
  if (!fileName.endsWith('.txt')) {
    fileName += '.txt';
  }

  const blob = new Blob([data], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;  // Utilise le nom personnalisé ici
  a.click();
  URL.revokeObjectURL(url);
});

// Import config TXT - inchangé
fileImportTxt.addEventListener('change', () => {
  if (fileImportTxt.files.length === 0) return;
  const file = fileImportTxt.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      localStorage.setItem('devisData', JSON.stringify(data));
      restoreData();
      alert('Configuration importée avec succès.');
    } catch {
      alert('Fichier invalide.');
    }
  };
  reader.readAsText(file);
  fileImportTxt.value = '';
});


  

  // Export PDF
// Fonction d'exportation en PDF avec le fond de la bulle pris en compte
btnExportPDF.addEventListener('click', () => {
  const fileNameInputValue = fileNameInput.value.trim();

  if (!fileNameInputValue) {
    alert('Merci de saisir un nom de fichier');
    return;
  }

  // Ajoute l'extension .pdf si nécessaire
  let fileName = fileNameInputValue.toLowerCase().endsWith('.pdf') ? fileNameInputValue : fileNameInputValue + '.pdf';

  const devisElement = document.getElementById('devisContainer');
  devisElement.classList.add('printMode');  // Appliquer un style d'impression pour améliorer la capture

  // Fonction de capture du style de l'élément
  function saveStyles(el, props) {
    const styles = {};
    props.forEach(p => { styles[p] = el.style[p]; });
    return styles;
  }

  function applyStyles(el, styles) {
    Object.entries(styles).forEach(([k,v]) => { el.style[k] = v; });
  }

  const propsToReset = ['height', 'maxHeight', 'overflow'];

  const elementsToExpand = [];
  let el = devisElement;
  while(el) {
    elementsToExpand.push(el);
    if(el.tagName === 'BODY') break;
    el = el.parentElement;
  }

  const savedStyles = elementsToExpand.map(el => ({el, styles: saveStyles(el, propsToReset)}));

  elementsToExpand.forEach(el => {
    el.style.height = 'auto';
    el.style.maxHeight = 'none';
    el.style.overflow = 'visible';
  });

  // Capture de l'élément pour l'exportation
  setTimeout(() => {
    html2canvas(devisElement, {
      scale: 2,  // Haute résolution
      useCORS: true,
      backgroundColor: "#fff",  // Assurez-vous que le fond est blanc
    }).then(canvas => {
      savedStyles.forEach(({el, styles}) => applyStyles(el, styles)); // Restaure les styles d'origine
      devisElement.classList.remove('printMode'); // Retirer le mode d'impression

      const imgData = canvas.toDataURL('image/png');
      const pdf = new jspdf.jsPDF('p', 'pt', 'a4');

      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pdfWidth - 40;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let position = 20;

      pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
      heightLeft -= pdfHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight + 20;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;
      }

      pdf.save(fileName); // Utilise le nom personnalisé ici
    }).catch(err => {
      savedStyles.forEach(({el, styles}) => applyStyles(el, styles)); // Restaure les styles d'origine
      devisElement.classList.remove('printMode'); // Retirer le mode d'impression
      alert('Erreur lors de la capture du devis : ' + err);
    });
  }, 100);
});




  // Collapsible sections toggling
  document.querySelectorAll('#configPanel section h2').forEach(h2 => {
    h2.addEventListener('click', () => {
      h2.parentElement.classList.toggle('collapsed');
    });
  });


  // Initial load
  window.addEventListener('DOMContentLoaded', () => {
    restoreData();
    renderArticles();
    updateDevisTable();
    updateDevisHeader();
    updateClientInfo();
    updateClientInfoVisibility();
    updateDevisFooter();
    updateSignatureLock();
    updateAutoDateInfoVisibility();
    renderSignatureArea();
  });



</script>
</body>
</html>
