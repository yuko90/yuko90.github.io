<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Devis complet sans colonne Ctva</title>
<style>
:root {
  --primary-color: #1e4f7a;
  --secondary-color: #2874a6;
  --bg-color: #fff;
  --text-color: #222;
  --text-light: #555;
  --border-color: #cfdde9;
  --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  --font-size-base: 11px;
  --font-weight-normal: 400;
  --font-weight-bold: 600;
  --radius: 4px;
}
body {
  font-family: var(--font-family);
  background: #f4f7fa;
  margin: 0;
  display: flex;
  min-height: 100vh;
  user-select: none;
}
#container {
  display: flex;
  width: 100%;
  max-width: 1150px;
  margin: 20px auto;
  gap: 15px;
  box-sizing: border-box;
  padding: 0 10px;
}
#configPanel {
  flex: 0 0 350px;
  background: var(--bg-color);
  border-radius: var(--radius);
  padding: 15px 18px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  overflow-y: auto;
  max-height: 90vh;
  border: 1px solid var(--border-color);
  font-size: 0.85rem;
  user-select: text;
}
#configPanel h2 {
  color: var(--secondary-color);
  margin-top: 0;
  margin-bottom: 12px;
  font-weight: 700;
  font-size: 1.1rem;
  border-bottom: 2.5px solid var(--secondary-color);
  padding-bottom: 6px;
  cursor: pointer;
  user-select: none;
  position: relative;
  padding-right: 20px;
  transition: color 0.3s ease;
}
#configPanel section.collapsed h2 {
  color: var(--text-light);
}
#configPanel section h2::after {
  content: "▼";
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  transition: transform 0.3s ease, content 0.3s ease;
  color: var(--secondary-color);
}
#configPanel section.collapsed h2::after {
  transform: translateY(-50%) rotate(-90deg);
  content: "▶";
  color: var(--text-light);
}
#configPanel section {
  margin-bottom: 20px;
  transition: margin-bottom 0.3s ease;
}
#configPanel section.collapsed {
  margin-bottom: 0 !important;
}
#configPanel section.collapsed > *:not(h2) {
  display: none !important;
  pointer-events: none;
  margin: 0 !important;
  padding: 0 !important;
  opacity: 0 !important;
  max-height: 0 !important;
  overflow: hidden !important;
}
#configPanel label {
  display: block;
  margin-top: 8px;
  font-weight: var(--font-weight-bold);
  color: var(--text-light);
}
#configPanel input[type="text"],
#configPanel input[type="email"],
#configPanel input[type="date"],
#configPanel input[type="number"],
#configPanel textarea,
#configPanel select {
  width: 100%;
  padding: 5px 9px;
  margin-top: 3px;
  font-size: 0.9rem;
  font-weight: var(--font-weight-normal);
  border: 1.4px solid var(--border-color);
  border-radius: var(--radius);
  box-sizing: border-box;
  resize: vertical;
  background: #fafafa;
  color: var(--text-color);
  transition: border-color 0.25s ease, background-color 0.25s ease;
}
#configPanel input[type="text"]:focus,
#configPanel input[type="email"]:focus,
#configPanel input[type="date"]:focus,
#configPanel input[type="number"]:focus,
#configPanel textarea:focus,
#configPanel select:focus {
  border-color: var(--secondary-color);
  background: #fff;
  outline: none;
}
#configPanel textarea {
  min-height: 60px;
  line-height: 1.3;
  font-family: var(--font-family);
}
#configPanel button {
  margin-top: 12px;
  padding: 7px 14px;
  background: var(--secondary-color);
  color: white;
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: var(--font-weight-bold);
  font-size: 0.9rem;
  user-select: none;
  box-shadow: 0 2px 5px rgba(40, 116, 166, 0.4);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}
#configPanel button:hover,
#configPanel button:focus {
  background: #1b3b5a;
}
#articlesList {
  max-height: 180px;
  overflow-y: auto;
  border: 1px solid var(--border-color);
  background: #fafafa;
  padding: 7px 8px;
  border-radius: var(--radius);
  color: var(--text-color);
  font-size: 0.85rem;
}
.articleItem {
  display: flex;
  gap: 6px;
  align-items: center;
  margin-bottom: 5px;
}
.articleItem input[type="text"],
.articleItem input[type="number"] {
  font-size: 0.85rem;
  padding: 4px 7px;
  border: 1.4px solid var(--border-color);
  border-radius: 3px;
  background: #fff;
  transition: border-color 0.25s ease;
}
.articleItem input[type="text"]:focus,
.articleItem input[type="number"]:focus {
  border-color: var(--secondary-color);
  outline: none;
}
.descInput {
  flex-grow: 1;
}
.priceInput {
  width: 65px;
  text-align: right;
}
.tvaInput {
  width: 50px;
  text-align: right;
}
.addToDevisBtn,
.removeArticleBtn {
  background: var(--secondary-color);
  color: white;
  border: none;
  padding: 4px 10px;
  font-size: 0.78rem;
  border-radius: var(--radius);
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
  box-shadow: 0 2px 4px rgba(40, 116, 166, 0.4);
  transition: background-color 0.3s ease;
}
.addToDevisBtn:hover,
.removeArticleBtn:hover {
  background: #1b3b5a;
}
#devisContainer {
  flex-grow: 1;
  background: var(--bg-color);
  border-radius: var(--radius);
  max-width: 800px;
  width: 100%;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  padding-left: 10px;
  padding-right: 10px;
  padding-top: 20px;
  padding-bottom: 20px;
  box-sizing: border-box;
  color: var(--text-color);
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  display: flex;
  flex-direction: column;
  min-width: 0;
  max-width: 100%;
  overflow-wrap: break-word;
  user-select: text;
}
#devisHeader {
  margin-bottom: 20px;
  line-height: 1.3;
  font-weight: 600;
  color: var(--text-color);
  user-select: text;
}
#devisHeader h2 {
  margin: 0 0 12px 0;
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--primary-color);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  user-select: none;
}
#devisHeader #topLine {
  display: flex;
  justify-content: space-between;
  margin-top: 8px;
  font-size: 0.9rem;
}
#devisHeader #companyInfo,
#devisHeader #clientInfo {
  font-weight: 400;
  font-size: 0.85rem;
  color: var(--text-light);
  line-height: 1.3;
}
#devisHeader #clientInfo {
  text-align: right;
}
#devisBody {
  padding: 0;
  margin: 0;
  overflow-x: auto;
  background: white;
  min-height: 50vh;
  display: flex;
  flex-direction: column;
}
#devisBody table {
  width: 100%;
  margin: 0;
  padding: 0;
  border-collapse: collapse;
  font-size: 10px;
  background: white;
  table-layout: fixed;
}
#devisBody table thead th {
  background-color: #2c5c85;
  color: white;
  padding: 8px 10px;
  font-weight: 700;
  border: none;
  text-align: left;
  white-space: nowrap;
}
/* Largeur et cadrage spécifique pour chaque colonne */
#devisBody table thead th:nth-child(1) { width: 8%; }
#devisBody table thead th:nth-child(2),
#devisBody table tbody td:nth-child(2) {
  width: 44%;
  font-size: 11px; /* taille diminuée de 2px */
}
#devisBody table thead th:nth-child(3) { width: 10%; }
#devisBody table thead th:nth-child(4) { width: 14%; }
#devisBody table thead th:nth-child(5) { width: 8%; }
/* Colonne Montant net HT renommée MNet HT */
#devisBody table thead th:nth-child(6),
#devisBody table tbody td:nth-child(6) {
  width: 10%;
  min-width: 80px;
  padding-right: 10px;
  text-align: right;
  white-space: nowrap;
}
#devisBody table thead th:nth-child(7) { width: 6%; }
#devisBody table tbody tr {
  border-bottom: 1px solid black;
}
#devisBody table tbody td {
  border: none;
  padding: 6px 8px;
  vertical-align: middle;
  word-break: break-word;
}
#devisBody table tbody td:nth-child(3),
#devisBody table tbody td:nth-child(4),
#devisBody table tbody td:nth-child(5),
#devisBody table tbody td:nth-child(6) {
  text-align: right;
}
#devisBody table tbody td:nth-child(7) {
  text-align: center;
  padding: 0;
}
#devisBody table input[type="number"] {
  font-size: 10px;
  padding: 2px 6px;
  max-width: 100%;
  box-sizing: border-box;
}

/* Cacher les spans d'impression par défaut */
.printOnly {
  display: none;
}

/* En mode impression (printMode), masquer inputs et afficher les spans */
.printMode input {
  display: none !important;
}
.printMode .printOnly {
  display: inline !important;
}

#totalsTable {
  margin-top: 10px;
  font-size: 11px;
}
#totalsTable thead th {
  text-align: right;
  padding: 4px 6px;
  border-bottom: 1.5px solid var(--primary-color);
}
#devisFooter {
  margin-top: 25px;
  font-size: 0.8rem;
  color: var(--text-light);
  line-height: 1.4;
  user-select: text;
  white-space: pre-line;
}
.printMode tbody td:nth-child(7),
.printMode thead th:nth-child(7) {
  display: none !important;
}
.printMode tbody td:nth-child(3) span.qtyText {
  display: inline !important;
}
@media (max-width: 960px) {
  #container {
    flex-direction: column;
    max-width: 95%;
  }
  #configPanel {
    width: 100%;
    max-height: none;
    margin-bottom: 25px;
  }
  #devisContainer {
    width: 100%;
    max-height: none;
    padding-left: 10px;
    padding-right: 10px;
  }
}
@media print {
  body {
    background: white;
    color: black;
    font-size: 10pt;
  }
  #container {
    max-width: 100%;
    margin: 0;
    padding: 0;
  }
  #configPanel {
    display: none;
  }
  #devisContainer {
    box-shadow: none;
    max-width: 100%;
    padding-left: 0;
    padding-right: 0;
  }
  #devisBody table {
    display: table !important;
    overflow: visible !important;
    max-height: none !important;
  }
}
</style>
</head>
<body>
<div id="container">
  <aside id="configPanel" aria-label="Configuration complète du devis">
    <section id="sectionHeader" class="collapsed">
      <h2>Entête du devis</h2>
      <label for="devisTitle">Titre du document</label>
      <input type="text" id="devisTitle" value="DEVIS" />
      <label for="companyName">Nom de l'entreprise</label>
      <input type="text" id="companyName" value="Mon Entreprise SARL" />
      <label for="companyAddress">Adresse</label>
      <input type="text" id="companyAddress" value="123 Rue de l'Exemple, 75000 Paris" />
      <label for="companyPhone">Téléphone</label>
      <input type="text" id="companyPhone" value="01 23 45 67 89" />
      <label for="companyEmail">Email</label>
      <input type="text" id="companyEmail" value="contact@monentreprise.fr" />
      <label for="companySiret">SIRET</label>
      <input type="text" id="companySiret" value="123 456 789 00012" />
      <label for="companyTva">TVA Intracom</label>
      <input type="text" id="companyTva" value="FR12345678901" />
    </section>
    <section id="sectionClient" class="collapsed">
      <h2>Informations client</h2>
      <label for="clientLastName">Nom</label>
      <input type="text" id="clientLastName" placeholder="Nom" />
      <label for="clientFirstName">Prénom</label>
      <input type="text" id="clientFirstName" placeholder="Prénom" />
      <label for="clientAddress">Adresse</label>
      <input type="text" id="clientAddress" placeholder="Adresse complète" />
      <label for="clientPostalCode">Code postal</label>
      <input type="text" id="clientPostalCode" placeholder="Code postal" />
      <label for="clientCity">Ville</label>
      <input type="text" id="clientCity" placeholder="Ville" />
      <label for="clientEmail">Email</label>
      <input type="email" id="clientEmail" placeholder="Email" />
      <label for="clientPhone">Téléphone</label>
      <input type="text" id="clientPhone" placeholder="Numéro de téléphone" />
      <label for="date">Date</label>
      <input type="date" id="date" />
      <label for="thankYouMsg" style="margin-top: 15px;">Message de remerciement</label>
      <textarea id="thankYouMsg" rows="4" style="width: 100%; padding:8px; font-size:14px; border-radius:4px;">Merci pour votre confiance.
Ce devis est valable 30 jours à partir de la date d'émission.</textarea>
    </section>
    <section id="sectionArticles" class="collapsed">
      <h2>Articles disponibles</h2>
      <div id="articlesList" aria-label="Liste des articles disponibles"></div>
      <h3 style="margin:10px 0 4px 0;">Ajouter un nouvel article</h3>
      <form id="addArticleForm" spellcheck="false" aria-label="Formulaire d'ajout d'article">
        <label for="newDesc">Description :</label>
        <input type="text" id="newDesc" required placeholder="Nom de l'article" />
        <label for="newPrice">Prix unitaire HT (€) :</label>
        <input type="number" id="newPrice" required min="0" step="0.01" placeholder="Ex: 25.50" />
        <label for="newTva">TVA (%) :</label>
        <input type="number" id="newTva" required min="0" max="100" step="0.01" placeholder="20" value="20" />
        <button type="submit" id="addArticleBtn">Ajouter l'article</button>
      </form>
    </section>
    <section>
      <h2>Export / Import configuration</h2>
      <div style="display:flex; gap:8px; flex-wrap: wrap;">
        <button id="btnExportTxt" style="flex-grow:1;">Exporter config en TXT</button>
        <input type="file" id="fileImportTxt" accept=".txt,text/plain" style="flex-grow:1;" />
      </div>
    </section>
  </aside>
  <main id="devisContainer" role="main" aria-label="Feuille de devis éditable">
    <div id="devisHeader" contenteditable="true" aria-label="En-tête du devis" spellcheck="false">
      <h2>DEVIS A EFFECTUER SUR PC J'AI PAS ENCORE TROUVE POUR TELEPHONE</h2>
      <div id="topLine">
        <strong id="companyNameDisplay">Mon Entreprise SARL</strong>
        <span id="clientFullNameDisplay"></span>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:6px;">
        <div id="companyInfo" style="max-width:48%;">
          <p style="margin:0;">
            <span id="companyAddressDisplay">123 Rue Exemple, 75000 Paris</span><br />
            <span id="companyPhoneDisplay">Tél : 01 23 45 67 89</span><br />
            <span id="companyEmailDisplay">Email : contact@monentreprise.fr</span><br />
            <span id="companySiretDisplay">SIRET : 123 456 789 00012</span><br />
            <span id="companyTvaDisplay">TVA Intracom : FR12345678901</span>
          </p>
        </div>
        <div id="clientInfo" style="max-width:48%; text-align:right;">
          <p style="margin:0;">
            <span id="clientAddressDisplay"></span><br />
            <span id="clientPostalCityDisplay"></span><br />
            <span id="clientEmailDisplay"></span><br />
            <span id="clientPhoneDisplay"></span><br />
            <span id="dateDisplay">Date :</span>
          </p>
        </div>
      </div>
    </div>
    <div id="devisBody" contenteditable="false" aria-label="Tableau des articles du devis" spellcheck="false">
      <table>
        <thead>
          <tr>
            <th>Réf.</th>
            <th>Description</th>
            <th>Qté/Tps</th>
            <th>Prix UT (€)</th>
            <th>Rem.%</th>
            <th>MNet HT</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="totalsTable" style="margin-top: 20px;">
      <table>
        <thead>
          <tr>
            <th>Total HT (€)</th>
            <th>Total TVA (€)</th>
            <th>Total TTC (€)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="totalHTValue" style="text-align:right;">0.00 €</td>
            <td id="totalTVAValue" style="text-align:right;">0.00 €</td>
            <td id="totalTTCValue" style="text-align:right;">0.00 €</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="devisFooter" contenteditable="true" aria-label="Message de fin de devis" spellcheck="false" style="margin-top:25px; font-size:0.8rem; color: var(--text-light); line-height:1.4; white-space: pre-line;">
      Merci pour votre confiance.<br />Ce devis est valable 30 jours à partir de la date d'émission.
    </div>
  </main>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  const devisTitleInput = document.getElementById('devisTitle');
  const companyNameInput = document.getElementById('companyName');
  const companyAddressInput = document.getElementById('companyAddress');
  const companyPhoneInput = document.getElementById('companyPhone');
  const companyEmailInput = document.getElementById('companyEmail');
  const companySiretInput = document.getElementById('companySiret');
  const companyTvaInput = document.getElementById('companyTva');
  const clientLastNameInput = document.getElementById('clientLastName');
  const clientFirstNameInput = document.getElementById('clientFirstName');
  const clientAddressInput = document.getElementById('clientAddress');
  const clientPostalCodeInput = document.getElementById('clientPostalCode');
  const clientCityInput = document.getElementById('clientCity');
  const clientEmailInput = document.getElementById('clientEmail');
  const clientPhoneInput = document.getElementById('clientPhone');
  const dateInput = document.getElementById('date');
  const thankYouMsgInput = document.getElementById('thankYouMsg');
  const articlesList = document.getElementById('articlesList');
  const addArticleForm = document.getElementById('addArticleForm');
  const newDescInput = document.getElementById('newDesc');
  const newPriceInput = document.getElementById('newPrice');
  const newTvaInput = document.getElementById('newTva');
  const body = document.getElementById('devisBody');
  const tbody = body.querySelector('tbody');
  const btnExportTxt = document.getElementById('btnExportTxt');
  const fileImportTxt = document.getElementById('fileImportTxt');
  let articles = [
    { desc: "Consultation", price: 50.00, tva: 20 },
    { desc: "Développement Web", price: 80.00, tva: 20 },
  ];
  let devisItems = [];
  function updateDevisHeader() {
    document.querySelector('#devisHeader h2').textContent = devisTitleInput.value || "DEVIS";
    document.getElementById('companyNameDisplay').textContent = companyNameInput.value || '';
    document.getElementById('companyAddressDisplay').textContent = companyAddressInput.value || '';
    document.getElementById('companyPhoneDisplay').textContent = 'Tél : ' + (companyPhoneInput.value || '');
    document.getElementById('companyEmailDisplay').textContent = 'Email : ' + (companyEmailInput.value || '');
    document.getElementById('companySiretDisplay').textContent = 'SIRET : ' + (companySiretInput.value || '');
    document.getElementById('companyTvaDisplay').textContent = 'TVA Intracom : ' + (companyTvaInput.value || '');
    const clientFullName = (clientLastNameInput.value + ' ' + clientFirstNameInput.value).trim();
    document.getElementById('clientFullNameDisplay').textContent = clientFullName;
    document.getElementById('clientAddressDisplay').textContent = clientAddressInput.value || '';
    document.getElementById('clientPostalCityDisplay').textContent = (clientPostalCodeInput.value + ' ' + clientCityInput.value).trim();
    document.getElementById('clientEmailDisplay').textContent = clientEmailInput.value || '';
    document.getElementById('clientPhoneDisplay').textContent = clientPhoneInput.value || '';
    document.getElementById('dateDisplay').textContent = 'Date : ' + (dateInput.value || '');
  }
  function updateDevisFooter() {
    const footer = document.getElementById('devisFooter');
    footer.innerHTML = thankYouMsgInput.value || "Merci pour votre confiance.\nCe devis est valable 30 jours à partir de la date d'émission.";
  }
  function renderArticles() {
    articlesList.innerHTML = '';
    articles.forEach((art, i) => {
      const div = document.createElement('div');
      div.className = 'articleItem';
      const descInput = document.createElement('input');
      descInput.type = 'text';
      descInput.value = art.desc;
      descInput.className = 'descInput';
      descInput.placeholder = "Description";
      descInput.addEventListener('input', () => { 
        articles[i].desc = descInput.value;
        saveData();
      });
      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.min = 0;
      priceInput.step = 0.01;
      priceInput.value = art.price.toFixed(2);
      priceInput.className = 'priceInput';
      priceInput.addEventListener('input', () => {
        let val = parseFloat(priceInput.value);
        articles[i].price = isNaN(val) ? 0 : val;
        saveData();
      });
      const tvaInput = document.createElement('input');
      tvaInput.type = 'number';
      tvaInput.min = 0;
      tvaInput.max = 100;
      tvaInput.step = 0.01;
      tvaInput.value = art.tva !== undefined ? art.tva : 20;
      tvaInput.className = 'tvaInput';
      tvaInput.title = 'TVA (%)';
      tvaInput.addEventListener('input', () => {
        let val = parseFloat(tvaInput.value);
        articles[i].tva = isNaN(val) ? 20 : val;
        saveData();
      });
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Ajouter';
      addBtn.className = 'addToDevisBtn';
      addBtn.title = 'Ajouter cet article au devis';
      addBtn.addEventListener('click', () => {
        addItemToDevis(1, art.price, art.tva, art.desc);
        saveData();
      });
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Supprimer';
      removeBtn.className = 'removeArticleBtn';
      removeBtn.title = 'Supprimer cet article';
      removeBtn.addEventListener('click', () => {
        if (confirm(`Supprimer l'article "${art.desc}" ?`)) {
          articles.splice(i, 1);
          renderArticles();
          updateDevisTable();
          saveData();
        }
      });
      div.appendChild(descInput);
      div.appendChild(priceInput);
      div.appendChild(tvaInput);
      div.appendChild(addBtn);
      div.appendChild(removeBtn);
      articlesList.appendChild(div);
    });
  }
  function addItemToDevis(qty, price, tva, desc) {
    const existing = devisItems.find(item => item.desc === desc);
    if (existing) {
      existing.qty += qty;
    } else {
      const ref = "REF" + String(devisItems.length + 1).padStart(3, '0');
      devisItems.push({ qty, price, tva, desc, reference: ref, remise: 0 });
    }
    updateDevisTable();
    saveData();
  }
  function updateDevisTable() {
    tbody.innerHTML = '';
    let totalHT = 0;
    let totalTVA = 0;
    devisItems.forEach((item, index) => {
      const tr = document.createElement('tr');
      
      // Référence
      const tdRef = document.createElement('td');
      tdRef.textContent = item.reference || '';
      tr.appendChild(tdRef);
      
      // Description
      const tdDesc = document.createElement('td');
      tdDesc.textContent = item.desc;
      tr.appendChild(tdDesc);
      
      // Qté/Tps
      const tdQty = document.createElement('td');
      tdQty.style.textAlign = 'right';
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = 0;
      qtyInput.value = item.qty;
      qtyInput.style.width = '60px';
      const qtySpan = document.createElement('span');
      qtySpan.textContent = item.qty;
      qtySpan.className = 'printOnly';
      qtyInput.addEventListener('change', () => {
        let val = parseInt(qtyInput.value);
        if (isNaN(val) || val < 0) val = 0;
        if (val === 0) {
          devisItems.splice(index, 1);
        } else {
          devisItems[index].qty = val;
        }
        updateDevisTable();
        saveData();
      });
      tdQty.appendChild(qtyInput);
      tdQty.appendChild(qtySpan);
      tr.appendChild(tdQty);
      
      // Prix UT
      const tdPrice = document.createElement('td');
      tdPrice.textContent = item.price.toFixed(2);
      tdPrice.style.textAlign = 'right';
      tr.appendChild(tdPrice);
      
      // Remise
      const tdRem = document.createElement('td');
      tdRem.style.textAlign = 'right';
      const remInput = document.createElement('input');
      remInput.type = 'number';
      remInput.min = 0;
      remInput.max = 100;
      remInput.step = 0.01;
      remInput.value = item.remise !== undefined ? item.remise : 0;
      remInput.style.width = '50px';
      const remSpan = document.createElement('span');
      remSpan.textContent = remInput.value;
      remSpan.className = 'printOnly';
      remInput.addEventListener('change', () => {
        let val = parseFloat(remInput.value);
        if (isNaN(val) || val < 0) val = 0;
        if (val > 100) val = 100;
        devisItems[index].remise = val;
        updateDevisTable();
        saveData();
      });
      tdRem.appendChild(remInput);
      tdRem.appendChild(remSpan);
      tr.appendChild(tdRem);
      
      // Montant net HT
      const netHT = item.qty * item.price * (1 - (item.remise || 0) / 100);
      const tdNetHT = document.createElement('td');
      tdNetHT.textContent = netHT.toFixed(2);
      tdNetHT.style.textAlign = 'right';
      tr.appendChild(tdNetHT);
      
      // Supprimer (diminue à l’unité)
      const tdRemove = document.createElement('td');
      tdRemove.style.textAlign = 'center';
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '✖';
      removeBtn.title = 'Supprimer une unité de cet article';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.padding = '2px 6px';
      removeBtn.style.fontSize = '1rem';
      removeBtn.style.lineHeight = '1';
      removeBtn.style.background = 'transparent';
      removeBtn.style.border = 'none';
      removeBtn.style.color = 'red';
      removeBtn.addEventListener('click', () => {
        if (devisItems[index].qty > 1) {
          devisItems[index].qty -= 1;
        } else {
          devisItems.splice(index, 1);
        }
        updateDevisTable();
        saveData();
      });
      tdRemove.appendChild(removeBtn);
      tr.appendChild(tdRemove);
      
      tbody.appendChild(tr);
      
      totalHT += netHT;
      totalTVA += netHT * (item.tva / 100);
    });
    const totalTTC = totalHT + totalTVA;
    document.getElementById('totalHTValue').textContent = totalHT.toFixed(2) + ' €';
    document.getElementById('totalTVAValue').textContent = totalTVA.toFixed(2) + ' €';
    document.getElementById('totalTTCValue').textContent = totalTTC.toFixed(2) + ' €';
  }
  addArticleForm.addEventListener('submit', e => {
    e.preventDefault();
    const desc = newDescInput.value.trim();
    const price = parseFloat(newPriceInput.value);
    const tva = parseFloat(newTvaInput.value);
    if (!desc || isNaN(price) || price < 0 || isNaN(tva) || tva < 0 || tva > 100) {
      alert('Merci de remplir correctement tous les champs de l\'article.');
      return;
    }
    if (articles.some(a => a.desc === desc)) {
      alert('Cette description existe déjà dans les articles disponibles.');
      return;
    }
    articles.push({ desc, price, tva });
    renderArticles();
    addArticleForm.reset();
    newTvaInput.value = "20";
    saveData();
  });
  function saveData() {
    const data = {
      headerForm: {
        devisTitle: devisTitleInput.value,
        companyName: companyNameInput.value,
        companyAddress: companyAddressInput.value,
        companyPhone: companyPhoneInput.value,
        companyEmail: companyEmailInput.value,
        companySiret: companySiretInput.value,
        companyTva: companyTvaInput.value,
      },
      clientForm: {
        clientLastName: clientLastNameInput.value,
        clientFirstName: clientFirstNameInput.value,
        clientAddress: clientAddressInput.value,
        clientPostalCode: clientPostalCodeInput.value,
        clientCity: clientCityInput.value,
        clientEmail: clientEmailInput.value,
        clientPhone: clientPhoneInput.value,
        date: dateInput.value,
        thankYouMsg: thankYouMsgInput.value,
      },
      articles,
      devisItems,
    };
    localStorage.setItem('devisData', JSON.stringify(data));
  }
  function restoreData() {
    const str = localStorage.getItem('devisData');
    if (!str) {
      return;
    }
    try {
      const data = JSON.parse(str);
      Object.entries(data.headerForm).forEach(([k, v]) => {
        const el = document.getElementById(k);
        if (el) el.value = v;
      });
      Object.entries(data.clientForm).forEach(([k, v]) => {
        const el = document.getElementById(k);
        if (el) el.value = v;
      });
      if (Array.isArray(data.articles)) articles = data.articles;
      if (Array.isArray(data.devisItems)) devisItems = data.devisItems;
      renderArticles();
      updateDevisTable();
      updateDevisHeader();
      updateDevisFooter();
    } catch (e) {
      console.error('Erreur restauration données :', e);
    }
  }
  [
    devisTitleInput, companyNameInput, companyAddressInput, companyPhoneInput, companyEmailInput,
    companySiretInput, companyTvaInput, clientLastNameInput, clientFirstNameInput, clientAddressInput,
    clientPostalCodeInput, clientCityInput, clientEmailInput, clientPhoneInput, dateInput
  ].forEach(input => {
    input.addEventListener('input', () => {
      updateDevisHeader();
      saveData();
    });
  });
  thankYouMsgInput.addEventListener('input', () => {
    updateDevisFooter();
    saveData();
  });
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key.toLowerCase() === 's') {
      e.preventDefault();
      saveData();
      alert('Données sauvegardées localement.');
    }
  });
  function getPanelDataAsText() {
    const data = {
      devisTitle: devisTitleInput.value,
      companyName: companyNameInput.value,
      companyAddress: companyAddressInput.value,
      companyPhone: companyPhoneInput.value,
      companyEmail: companyEmailInput.value,
      companySiret: companySiretInput.value,
      companyTva: companyTvaInput.value,
      clientLastName: clientLastNameInput.value,
      clientFirstName: clientFirstNameInput.value,
      clientAddress: clientAddressInput.value,
      clientPostalCode: clientPostalCodeInput.value,
      clientCity: clientCityInput.value,
      clientEmail: clientEmailInput.value,
      clientPhone: clientPhoneInput.value,
      date: dateInput.value,
      thankYouMsg: thankYouMsgInput.value,
    };
    let lines = [];
    for (const [key, value] of Object.entries(data)) {
      lines.push(`${key}=${encodeURIComponent(value)}`);
    }
    if (articles && Array.isArray(articles)) {
      const jsonStr = JSON.stringify(articles);
      const encoded = btoa(unescape(encodeURIComponent(jsonStr)));
      lines.push(`articles=${encoded}`);
    }
    return lines.join('\n');
  }
  function applyPanelDataFromText(text) {
    const lines = text.split('\n');
    lines.forEach(line => {
      const [key, encodedValue] = line.split('=');
      if (!key) return;
      const value = decodeURIComponent(encodedValue || '');
      if (key === 'articles') {
        try {
          const jsonStr = decodeURIComponent(escape(atob(value)));
          const importedArticles = JSON.parse(jsonStr);
          if (Array.isArray(importedArticles)) {
            articles = importedArticles;
            renderArticles();
            updateDevisTable();
          }
        } catch (e) {
          console.warn('Erreur import articles:', e);
        }
      } else {
        const el = document.getElementById(key);
        if (el) {
          el.value = value;
          el.dispatchEvent(new Event('input'));
        }
      }
    });
  }
  function exportPanelToTxt() {
    const text = getPanelDataAsText();
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'panel_data.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function importPanelFromFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      applyPanelDataFromText(e.target.result);
    };
    reader.readAsText(file);
  }
  btnExportTxt.addEventListener('click', exportPanelToTxt);
  fileImportTxt.addEventListener('change', () => {
    if (fileImportTxt.files.length > 0) {
      importPanelFromFile(fileImportTxt.files[0]);
      fileImportTxt.value = '';
    }
  });
  function setupButtons() {
    const configPanel = document.getElementById('configPanel');
    if (document.getElementById('exportPdfBtn')) return;
    const buttonsContainer = document.createElement('div');
    buttonsContainer.style.display = 'flex';
    buttonsContainer.style.flexDirection = 'column';
    buttonsContainer.style.gap = '8px';
    buttonsContainer.style.marginTop = '12px';
    const exportPdfBtn = document.createElement('button');
    exportPdfBtn.id = 'exportPdfBtn';
    exportPdfBtn.textContent = 'Exporter en PDF';
    exportPdfBtn.style.padding = '8px 14px';
    exportPdfBtn.style.backgroundColor = 'var(--secondary-color)';
    exportPdfBtn.style.color = 'white';
    exportPdfBtn.style.border = 'none';
    exportPdfBtn.style.borderRadius = '4px';
    exportPdfBtn.style.cursor = 'pointer';
    exportPdfBtn.title = 'Exporter le devis en PDF';
    exportPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');
      const devisElement = document.getElementById('devisContainer');
      devisElement.classList.add('printMode');
      updateDevisTable();
      html2canvas(devisElement, {
        scale: 2,
        backgroundColor: null,
        useCORS: true,
        scrollX: 0,
        scrollY: -window.scrollY,
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('devis.pdf');
        devisElement.classList.remove('printMode');
        updateDevisTable();
      }).catch(err => {
        alert('Erreur lors de la génération du PDF : ' + err.message);
        devisElement.classList.remove('printMode');
        updateDevisTable();
      });
    });
    buttonsContainer.appendChild(exportPdfBtn);
    configPanel.appendChild(buttonsContainer);
  }
  document.addEventListener('DOMContentLoaded', () => {
    restoreData();
    updateDevisHeader();
    updateDevisFooter();
    renderArticles();
    updateDevisTable();
    setupButtons();
    document.querySelectorAll('#configPanel section h2').forEach(header => {
      header.addEventListener('click', () => {
        header.parentElement.classList.toggle('collapsed');
      });
    });
  });
</script>
</body>
</html>
